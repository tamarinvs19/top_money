{% extends 'base.html' %}
{% block title %}Statistics - Finance Manager{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
  <h2>Statistics</h2>
  <div class="btn-group btn-group-sm" role="group">
    {% if period == 'month' %}
      <a href="#" class="btn btn-outline-secondary active">Month</a>
      <a href="{% url 'statistics_year' year %}" class="btn btn-outline-secondary">Year</a>
    {% else %}
      <a href="{% url 'statistics_month' year month %}" class="btn btn-outline-secondary">Month</a>
      <a href="#" class="btn btn-outline-secondary active">Year</a>
    {% endif %}
  </div>
</div>

<div class="card mb-2">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      {% if period == 'month' %}
        <a href="{% url 'statistics_month' prev_year prev_month %}" class="btn btn-sm btn-outline-secondary">&larr; Prev</a>
        <h4 class="mb-0">{{ month }}/{{ year }}</h4>
        <a href="{% url 'statistics_month' next_year next_month %}" class="btn btn-sm btn-outline-secondary">Next &rarr;</a>
      {% else %}
        <a href="{% url 'statistics_year' prev_year %}" class="btn btn-outline-secondary">&larr; Prev</a>
        <h4 class="mb-0">{{ year }}</h4>
        <a href="{% url 'statistics_year' next_year %}" class="btn btn-outline-secondary">Next &rarr;</a>
      {% endif %}
    </div>
  </div>
</div>

<ul class="nav nav-tabs mb-2">
  {% if period == 'month' %}
  <li class="nav-item">
    <a class="nav-link {% if stat_type == 'income' %}active{% endif %}" href="{% url 'statistics_month_type' year month 'income' %}">
      Income <span class="text-success">+{{ total_income|floatformat:2 }} ₽</span>
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if stat_type == 'outcome' %}active{% endif %}" href="{% url 'statistics_month_type' year month 'outcome' %}">
      Outcome <span class="text-danger">-{{ total_outcome|floatformat:2 }} ₽</span>
    </a>
  </li>
  {% else %}
  <li class="nav-item">
    <a class="nav-link {% if stat_type == 'income' %}active{% endif %}" href="{% url 'statistics_year_type' year 'income' %}">
      Income <span class="text-success">+{{ total_income|floatformat:2 }} ₽</span>
    </a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if stat_type == 'outcome' %}active{% endif %}" href="{% url 'statistics_year_type' year 'outcome' %}">
      Outcome <span class="text-danger">-{{ total_outcome|floatformat:2 }} ₽</span>
    </a>
  </li>
  {% endif %}
</ul>

{% if stat_type == 'income' %}
<div class="row">
  <div class="col-lg-6 mb-2">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Income by Category</h5>
        {% if income_data %}
        <div class="canvas-chart">
          <canvas id="incomeChart"></canvas>
        </div>
        {% else %}
        <p class="text-muted text-center py-5">No income data</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-6 mb-2">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Income Details</h5>
        {% if income_data %}
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Category</th>
                <th class="text-end">Amount</th>
                <th class="text-end">%</th>
              </tr>
            </thead>
            <tbody>
              {% for item in income_data %}
              <tr>
                <td><span style="display:inline-block;width:12px;height:12px;background-color:{{ item.color }};margin-right:8px;border-radius:2px;"></span>{{ item.category }}</td>
                <td class="text-end">{{ item.amount|floatformat:2 }} ₽</td>
                <td class="text-end">{{ item.percent|floatformat:1 }}%</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted text-center py-5">No income data</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% else %}
<div class="row">
  <div class="col-lg-6 mb-2">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Outcome by Category</h5>
        {% if outcome_data %}
        <div class="canvas-chart" >
          <canvas id="outcomeChart"></canvas>
        </div>
        {% else %}
        <p class="text-muted text-center py-5">No outcome data</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-6 mb-2">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Outcome Details</h5>
        {% if outcome_data %}
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Category</th>
                <th class="text-end">Amount</th>
                <th class="text-end">%</th>
              </tr>
            </thead>
            <tbody>
              {% for item in outcome_data %}
              <tr>
                <td><span style="display:inline-block;width:12px;height:12px;background-color:{{ item.color }};margin-right:8px;border-radius:2px;"></span>{{ item.category }}</td>
                <td class="text-end">{{ item.amount|floatformat:2 }} ₽</td>
                <td class="text-end">{{ item.percent|floatformat:1 }}%</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted text-center py-5">No outcome data</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const outsideLabelsPlugin = {
  id: 'outsideLabels',
  afterDraw(chart) {
    const { ctx, data, chartArea } = chart;
    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
    if (total === 0) return;
    
    ctx.save();
    ctx.font = '11px sans-serif';
    ctx.textBaseline = 'middle';
    
    const centerX = (chartArea.left + chartArea.right) / 2;
    const centerY = (chartArea.top + chartArea.bottom) / 2;
    const radius = Math.min(chartArea.width, chartArea.height) / 2;
    
    data.datasets[0].data.forEach((value, i) => {
      const meta = chart.getDatasetMeta(0);
      const arc = meta.data[i];
      
      const startAngle = arc.startAngle;
      const endAngle = arc.endAngle;
      const midAngle = (startAngle + endAngle) / 2;
      
      const lineStartX = centerX + Math.cos(midAngle) * radius;
      const lineStartY = centerY + Math.sin(midAngle) * radius;
      const lineEndX = centerX + Math.cos(midAngle) * (radius + 15);
      const lineEndY = centerY + Math.sin(midAngle) * (radius + 15);
      
      const labelX = centerX + Math.cos(midAngle) * (radius + 5);
      const textAlign = midAngle > -Math.PI/2 && midAngle < Math.PI/2 ? 'left' : 'right';
      const label = data.labels[i];
      const percent = ((value / total) * 100).toFixed(0);
      
      if (percent > 9) {
        ctx.beginPath();
        ctx.moveTo(lineStartX, lineStartY);
        ctx.lineTo(lineEndX, lineEndY);
        ctx.strokeStyle = '#999';
        ctx.lineWidth = 1;
        ctx.stroke();
        
        ctx.fillStyle = '#333';
        ctx.textAlign = textAlign;
        ctx.fillText(`${label}`, labelX + (textAlign === 'left' ? 5 : -5), lineEndY + (textAlign === 'left' ? 7 : -7));
      }
    });
    
    ctx.restore();
  }
};

Chart.register(outsideLabelsPlugin);

const colors = [
  '#ff6b6b', '#ffa07a', '#ffd93d', '#6bcb77', '#4d96ff',
  '#9b59b6', '#ff9ff3', '#54a0ff', '#5f27cd', '#48dbfb',
  '#ff9f43', '#ee5a24', '#009432', '#1289A7', '#D980FA'
];

{% if stat_type == 'income' and income_data %}
new Chart(document.getElementById('incomeChart'), {
  type: 'pie',
  data: {
    labels: [{% for item in income_data %}'{{ item.category }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
    datasets: [{
      data: [{% for item in income_data %}{{ item.amount }}{% if not forloop.last %}, {% endif %}{% endfor %}],
      backgroundColor: colors,
      borderWidth: 2,
      borderColor: '#fff',
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    layout: {
      padding: 40
    },
    plugins: {
      legend: {
        display: false
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            const value = context.raw;
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = ((value / total) * 100).toFixed(1);
            return context.label + ': ' + value.toLocaleString() + ' ₽ (' + percentage + '%)';
          }
        }
      }
    }
  }
});
{% endif %}

{% if stat_type == 'outcome' and outcome_data %}
new Chart(document.getElementById('outcomeChart'), {
  type: 'pie',
  data: {
    labels: [{% for item in outcome_data %}'{{ item.category }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
    datasets: [{
      data: [{% for item in outcome_data %}{{ item.amount }}{% if not forloop.last %}, {% endif %}{% endfor %}],
      backgroundColor: colors,
      borderWidth: 2,
      borderColor: '#fff',
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    layout: {
      padding: 40
    },
    plugins: {
      legend: {
        display: false
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            const value = context.raw;
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = ((value / total) * 100).toFixed(1);
            return context.label + ': ' + value.toLocaleString() + ' ₽ (' + percentage + '%)';
          }
        }
      }
    }
  }
});
{% endif %}
</script>
{% endblock %}
